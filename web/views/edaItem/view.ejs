<script src="/scripts/three.js"></script>
<script src="/scripts/three.TrackballControls.js"></script>
<script src="/scripts/three.RequestAnimationFrame.js"></script>

<form action="/schematicSymbol/<%= item.id %>" method="POST">
  <input type="hidden" id="type" name="type" value="<%= item.type %>"/>

  <div class="row schematicSymbol">
    <div class="span1">
      <% if(item.id !== 'new') { %>
      <div class="vote">
        <a id="voteUp" class="<%= item.vote == 1 ? 'voteUpOn' : 'voteUpOff' %>" href="javascript:">up vote</a>
        <span id="voteCount" class="voteCount"><%= item.voteCount || 0 %></span>
        <a id="voteDown" class="<%= item.vote == -1 ? 'voteDownOn' : 'voteDownOff' %>" href="javascript:">down vote</a>

        <a id="favorite" class="<%= item.isFavorite ? 'favoriteOn' : 'favoriteOff' %>" href="javascript:">favorite</a>

        <div id="favoriteCount" class="favoriteCount"><%= item.favoriteCount || '' %></div>
      </div>
      <% } %>
    </div>
    <div class="span4">
      <ul class="nav nav-tabs">
        <li class="active"><a href="#view2d" data-toggle="tab">2D View</a></li>
        <% if(item.has3d) { %>
        <li><a href="#view3d" data-toggle="tab">3D View</a></li>
        <% } %>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="view2d">
          <div id="svgContainer"></div>
        </div>
        <div class="tab-pane" id="view3d">
          <div id="shape3dContainer"></div>
        </div>
      </div>

      <!-- Code -->
      <% if(editable) { %>
      <div class="readWriteField <%= getValidationErrorClass('code') %>">
        <label class="title">KiCad Code:</label>
        <textarea type="text" class="value" name="code" id="code" style="width: 340px; height: 200px;" onchange="updateRender();" onkeyup="updateRender();"><%=
          item.code %></textarea>

        <div id="codeErrors" class="codeErrors"></div>
        <%- getValidationError('code') %>
      </div>
      <% } %>
    </div>
    <div class="span7">
      <!-- Title -->
      <div class="readWriteField <%= getValidationErrorClass('title') %>">
        <label class="title">Title:</label>
        <% if(editable) { %>
        <input type="text" class="value" name="title" value="<%= item.title %>"/>
        <%- getValidationError('title') %>
        <% } else { %>
        <span class="value"><%= item.title %></span>
        <% } %>
      </div>

      <!-- Description -->
      <div class="readWriteField <%= getValidationErrorClass('description') %>">
        <label class="title">Description:</label>
        <% if(editable) { %>
        <textarea type="text" class="value" name="description" style="width: 400px; height: 200px;"><%= item.description
          %></textarea>
        <%- getValidationError('description') %>
        <% } else { %>
        <pre class="value"><%= item.description %></pre>
        <% } %>
      </div>

      <!-- Keywords -->
      <div class="readWriteField <%= getValidationErrorClass('keywords') %>">
        <label class="title">Keywords:</label>
        <% if(editable) { %>
        <input type="text" class="value" name="keywords" value="<%= item.keywords %>"/>
        <%- getValidationError('keywords') %>
        <% } else { %>
        <span class="value"><%= item.keywords %></span>
        <% } %>
      </div>

      <!-- Created By -->
      <div class="readonlyField">
        <span class="title">Created By:</span><span class="value"><a href="/user/<%= item.createdBy.id %>"><%=
        item.createdBy.username %></a></span>
      </div>

      <!-- Modified Date -->
      <div class="readonlyField">
        <span class="title">Modified Date:</span><span class="value"><%= sf('{0:MM/dd/yyyy}', new Date(item.modifiedDate)) %></span>
      </div>

      <!-- Actions -->
      <% if(editable) { %>
      <br/>
      <input type="submit" class="btn btn-primary" href="/schematicSymbol/<%= item.id %>" title="Save" value="Save"/>
      <% } %>
    </div>
  </div>
</form>

<script type="text/javascript">
  var schematicSymbolId = '<%= item.id %>';
  var isLoggedIn = '<%= session.user ? true : false %>' == 'true';

  $(function() {
    $('#voteUp').click(function() {
      if (isLoggedIn) {
        var state = getUpDownState();
        var newState = state === 'up' ? 'none' : 'up';
        changeUpDownState(newState);
        $.post('/schematicSymbol/' + schematicSymbolId + '/vote', { state: newState }, function(data) {
          changeUpDownCount(data.voteCount);
        });
      } else {
        myAlert("info", "You must be logged in to vote.");
      }
    });

    $('#voteDown').click(function() {
      if (isLoggedIn) {
        var state = getUpDownState();
        var newState = state === 'down' ? 'none' : 'down';
        changeUpDownState(newState);
        $.post('/schematicSymbol/' + schematicSymbolId + '/vote', { state: newState }, function(data) {
          changeUpDownCount(data.voteCount);
        });
      } else {
        myAlert("info", "You must be logged in to vote.");
      }
    });

    $('#favorite').click(function() {
      if (isLoggedIn) {
        var state = getFavoriteState();
        var newState = !state;
        changeFavoriteState(newState);
        $.post('/schematicSymbol/' + schematicSymbolId + '/favorite', { state: newState }, function(data) {
          changeFavoriteCount(data.favoriteCount);
        });
      } else {
        myAlert("info", "You must be logged in to favorite a schematic symbol.");
      }
    });

    $('a[data-toggle="tab"]').on('show', function(e) {
      console.log(e);
    });

    render3d();
  });

  function render3d() {
    try {
      var url = '/pcbModule/<%= item.id %>.webgl.js';
      var width = 350;
      var height = 350;
      var floor = 0;
      var shape3dContainer = document.getElementById('shape3dContainer');

      // camera
      var camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(2, -2, 2);
      camera.lookAt(0, 0, 0);

      // scene
      var scene = new THREE.Scene();

      // lights
      var ambient = new THREE.AmbientLight(0xffffff);
      scene.add(ambient);

      // more lights
      var directionalLight = new THREE.DirectionalLight(0xffeedd);
      directionalLight.position.set(0, -10, 20).normalize();
      scene.add(directionalLight);

      // controls
      var controls = new THREE.TrackballControls(camera, shape3dContainer);
      controls.target.set(0, 0, 0);

      controls.rotateSpeed = 1.0;
      controls.zoomSpeed = 1.2;
      controls.panSpeed = 0.8;

      controls.noZoom = false;
      controls.noPan = false;

      controls.staticMoving = false;
      controls.dynamicDampingFactor = 0.15;

      // renderer
      var webglRenderer = new THREE.WebGLRenderer();
      webglRenderer.setSize(width, height);
      webglRenderer.domElement.style.position = "relative";
      shape3dContainer.appendChild(webglRenderer.domElement);

      // loader
      var loader = new THREE.JSONLoader();
      var callbackModel = function(geometry) { createScene(geometry, 90, floor, -50, 105) };
      return loader.load(url, callbackModel);
    } catch (e) {
      $('#shape3dContainer').html("Missing WebGL Support in your browser.");
    }

    function createScene(geometry, x, y, z, b) {
      var zmesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({
        color: 0xAB962B
      }));
      zmesh.position.set(0, 0, 0);
      zmesh.scale.set(1, 1, 1);
      scene.add(zmesh);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      webglRenderer.render(scene, camera);
    }
  }

  function getFavoriteState() {
    return $('#favorite').hasClass('favoriteOn');
  }

  function changeFavoriteState(state) {
    var favorite = $('#favorite');
    if (state) {
      favorite.addClass('favoriteOn').removeClass('favoriteOff');
    } else {
      favorite.addClass('favoriteOff').removeClass('favoriteOn');
    }
  }

  function changeFavoriteCount(count) {
    $('#favoriteCount').text(count);
  }

  function getUpDownState() {
    if ($('#voteUp').hasClass('voteUpOn')) {
      return 'up';
    }
    if ($('#voteDown').hasClass('voteDownOn')) {
      return 'down';
    }
    return 'none';
  }

  function changeUpDownCount(count) {
    $('#voteCount').text(count);
  }

  function changeUpDownState(state) {
    var voteUp = $('#voteUp');
    var voteDown = $('#voteDown');

    if (state === 'up') {
      voteUp.addClass('voteUpOn').removeClass('voteUpOff');
      voteDown.addClass('voteDownOff').removeClass('voteDownOn');
    } else if (state === 'down') {
      voteUp.addClass('voteUpOff').removeClass('voteUpOn');
      voteDown.addClass('voteDownOn').removeClass('voteDownOff');
    } else {
      voteUp.addClass('voteUpOff').removeClass('voteUpOn');
      voteDown.addClass('voteDownOff').removeClass('voteDownOn');
    }
  }

  function updateRender() {
    render($('#code').val());
  }

  function render(data) {
    if (!data) {
      return;
    }
    var type = $('#type').val();
    var codeErrors = $('#codeErrors');
    try {
      codeErrors.text('');
      if (type == EdaItem.types.schematicSymbol) {
        renderSchematicSymbol('#svgContainer', data, {
          size: 350
        });
      } else {
        renderPcbModule('#svgContainer', data, {
          size: 350
        });
      }
    } catch (e) {
      codeErrors.text('' + e);
      console.error('Could not render', e.stack);
    }
  }
</script>
<script type="text/javascript">
  // keep this in a separate block unless it has broken code.
  render('<%- item.jsKiCadData %>');
</script>